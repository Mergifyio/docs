## Using Mergify with Graphite

[Graphite](https://graphite.dev) is a modern code review tool designed for fast-moving teams. It helps engineers write and review smaller pull requests (PRs), stay unblocked, and ship faster. In this documentation, we will explain how to use Mergify with Graphite and highlight some important configurations.

### Prerequisites

Before getting started, make sure you have the following prerequisites in place:

- A GitHub repository ready for Mergify usage.
- Graphite installed and configured for your project. If you are not familiar with Graphite, we recommend following their [quick start guide](https://graphite.dev/docs/graphite-quick-start).

### Step 1: Building our Sample Stack of Pull Requests

Assuming your "trunk branch" is named `main`, execute the following commands in your repository folder to build three branches stacked on top of each other over `main`:

```shell
git checkout main
git pull

git checkout -b "A"
type nul > "file_A"
git add "file_A"
git commit -a -m "A"

git checkout -b "B"
type nul > "file_B"
git add "file_B"
git commit -a -m "B"

git checkout -b "C"
type nul > "file_C"
git add "file_C"
git commit -a -m "C"
```

You should have the following structure in your repository:

```
o C
‚îÇ
o B
‚îÇ
o A
‚îÇ
o main
‚îÇ
:
```

Submit your stack by running the following command. For the three branches, leave the default title, choose `Skip (leave empty)` for the body option and `Publish Pull Request` for the submit option:

```shell
gt stack submit
```

In the end, your output should resemble the following:

```shell
ü•û Validating that this Graphite stack is ready to submit...

‚úèÔ∏è  Preparing to submit PRs for the following branches...
‚ñ∏ A (Create)
‚úî Title ‚Ä¶ A
‚úî Body ‚Ä∫ Skip (leave empty)
‚úî Submit ‚Ä∫ Publish Pull Request
‚ñ∏ B (Create)
‚úî Title ‚Ä¶ B
‚úî Body ‚Ä∫ Skip (leave empty)
‚úî Submit ‚Ä∫ Publish Pull Request
‚ñ∏ C (Create)
‚úî Title ‚Ä¶ C
‚úî Body ‚Ä∫ Skip (leave empty)
‚úî Submit ‚Ä∫ Publish Pull Request

üì® Pushing to remote and creating/updating PRs...
A: https://app.graphite.dev/github/pr/OWNER/YOUR_REPO/X (created)
B: https://app.graphite.dev/github/pr/OWNER/YOUR_REPO/Y (created)
C: https://app.graphite.dev/github/pr/OWNER/YOUR_REPO/Z (created)
```

### Step 2: Activating "Automatically delete head branches" on Your Repository

To ensure seamless integration between Mergify and Graphite, you need to activate the **Automatically Delete Head Branches** setting on your GitHub repository. Enabling this setting allows GitHub to automatically delete the head branch upon pull request merge and change the base branch of upstack pull requests to the branch in which the PR was merged.

For example, in our sample stack, when PR A is merged into `main`, enabling this setting will delete branch A and change the base branch of PR B from A to `main`.

To activate **Automatically delete head branches**, follow the steps outlined in the [GitHub documentation: Managing the automatic deletion of branches](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/configuring-pull-request-merges/managing-the-automatic-deletion-of-branches).

### Step 2: Configuring Mergify

To configure Mergify for your repository, modify the [.mergify.yml configuration file](/configuration/file-format) on the `main` branch. Set a condition on the `base` attribute to be equal to the name of your trunk branch (`main` in our sample stack). This ensures that Mergify only merges a PR that is at the bottom of its stack.

Here is a sample of what your `.mergify.yml` file could look like for our sample stack:

```yaml
pull_request_rules:
  - name: Merge on approval
    conditions:
      - label=Approved
      - base=main
    actions:
      queue:
        name: default

queue_rules:
  - name: default
    conditions:
      - base=main
```

**Note:** *We assume that you are following this guide alone, so we can't use the PR approval system since authors can't approve their own PR. We will mimic approval by adding a label.*

If you make changes to your `.mergify.yml` file, make sure your changes are on the `main` branch and that your stack is up to date. Execute the following commands to ensure this:

```shell
git switch main
git pull
git switch C
gt stack restack
gt stack submit
```

### Step 3: Let the Magic Happen

Now that everything is set up, you can go to the [Graphite dashboard](https://app.graphite.dev/) (or you can do it directly on GitHub if you prefer) and "approve" PR A by adding the `Approved` label. Wait a few seconds and observe Mergify automatically merging PR A into `main`. GitHub will then delete branch A and set `main` as the base branch for PR B.

Suppose PR B is not yet ready, but PR C is. Approve PR C with the label and wait as long as you want. Nothing will happen until PR B is approved. As soon as PR B is approved, it will be merged into `main`, and GitHub will handle the branch changes accordingly. PR C will then be merged into `main`.
